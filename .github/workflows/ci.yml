name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Format check
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      
      - name: Check formatting
        run: cargo fmt --all -- --check

  # Clippy lint check
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Run Clippy
        run: cargo clippy --all-targets -- -D warnings

  # Tests on multiple platforms
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
      # Don't fail entire job if one platform fails
      max-parallel: 3
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Install LLVM (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm clang
      
      - name: Install LLVM (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install llvm
          echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH
      
      - name: Install LLVM (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install llvm -y
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
        continue-on-error: true  # LLVM may already be installed
      
      - name: Run unit tests
        run: cargo test --lib --verbose
      
      - name: Run LSP tests
        run: |
          cd pain-lsp
          cargo test --tests --verbose
        continue-on-error: false
      
      - name: Run integration tests
        run: cargo test --test integration_test --verbose
      
      - name: Run full pipeline integration tests
        run: cargo test --test full_pipeline_integration --verbose
        continue-on-error: true  # May fail if LLVM tools not available
      
      - name: Run property-based tests
        run: cargo test --test property_tests --verbose
        continue-on-error: true  # Property tests may be flaky
      
      - name: Run performance regression tests
        run: cargo test --test performance_regression --verbose
        continue-on-error: true  # Performance tests may vary by platform
      
      - name: Test summary
        if: always()
        run: |
          echo "## Test Results for ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- LSP tests: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Full pipeline tests: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Property-based tests: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance regression tests: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # Build check on all platforms
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build all packages
        run: cargo build --release --all
